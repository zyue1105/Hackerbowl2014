<html>
<head>  
  <script type="text/javascript" src="https://rawgithub.com/mozilla/pdf.js/gh-pages/build/pdf.js"></script>
    
  <title>Converting PDF To Text using pdf.js</title>
  <style>.textLayer { display: none; }</style>
</head>

<body>
  
  <div id="viewer" style="display:none"></div>
  
  <span id="preview"></span>
  <input type="file" onchange="displayPreview(this.files);" />
  <canvas id="the-canvas" style="border:3px solid black"></canvas>    
  
  <!--script type="text/javascript" id="pdf_mozilla-js" src="pdf_mozilla.js"></script-->
  <script type="text/javascript" id="pdf-js" src="pdf.js"></script>
  <!--script type="text/javascript" id="pdf_original-js" src="pdf_original.js"></script-->  
  <!--script>PDFJS_new.workerSrc = document.getElementById("pdf-js").getAttribute("src");</script-->
  
  <script>         
  
  var pdf2text;
  
  function convertDataURIToBinary(dataURI) {
    var BASE64_MARKER = ';base64,';
  
    var base64Index = dataURI.indexOf(BASE64_MARKER) + BASE64_MARKER.length;
    var base64 = dataURI.substring(base64Index);
    var raw = window.atob(base64);
    var rawLength = raw.length;
    var array = new Uint8Array(new ArrayBuffer(rawLength));    

    for(i = 0; i < rawLength; i++) {
      array[i] = raw.charCodeAt(i);
    }
    return array;
  }
  
  function onFileLoad(e) { 
    console.log(e.target.result);       
    
    // convert the base64 string to a Uint8Array.
    var pdfAsArray = convertDataURIToBinary(e.target.result);  
    
    //PDFJS_new.workerSrc = document.getElementById("pdf-js").getAttribute("src");
    //var pdf = new PDFJS_new.PDFDoc(pdfAsArray);
    
    /*var div = document.getElementById('viewer');      
    var total = pdf.numPages;
    var complete = 0;
    
    for (i = 1; i <= total; i++){
      var page = pdf.getPage(i);

      var canvas = document.createElement('canvas');
      canvas.id = 'page' + i;
      canvas.mozOpaque = true;
      div.appendChild(canvas);

      canvas.width = page.width;
      canvas.height = page.height;

      var context = canvas.getContext('2d');
      context.save();
      context.fillStyle = 'rgb(255, 255, 255)';
      context.fillRect(0, 0, canvas.width, canvas.height);
      context.restore();       
      
      var textLayer = document.createElement('div');
      textLayer.className = 'textLayer';
      document.body.appendChild(textLayer);
      
      page.startRendering(context, function(){
        if (++complete == total){
                      
          window.setTimeout(function(){
            var layers = [];
            var nodes = document.querySelectorAll(".textLayer > div");
            for (var j = 0; j < nodes.length; j++){
              layers.push(nodes[j].textContent + "\n");
            }
            pdf2text = layers.join("\n");
                          
          }, 1000);
        }
      }, textLayer);
    }*/
        
        
    PDFJS.getDocument(pdfAsArray).then(function getPdfHelloWorld(pdf) {
      //
      // Fetch the first page
      //
      pdf.getPage(1).then(function getPageHelloWorld(page) {
        var scale = 1.5;
        var viewport = page.getViewport(scale);

        //
        // Prepare canvas using PDF page dimensions
        //
        var canvas = document.getElementById('the-canvas');
        var context = canvas.getContext('2d');
        canvas.height = viewport.height;
        canvas.width = viewport.width;

        //
        // Render PDF page into canvas context
        //
        page.render({canvasContext: context, viewport: viewport});        
      });          
      
    });
        
    
    PDFJS_new.workerSrc = document.getElementById("pdf-js").getAttribute("src");
    var pdf = new PDFJS_new.PDFDoc(pdfAsArray);
    
    var div = document.getElementById('viewer');      
    var total = pdf.numPages;
    var complete = 0;
    
    for (i = 1; i <= total; i++){
      var page = pdf.getPage(i);

      var canvas = document.createElement('canvas');
      canvas.id = 'page' + i;
      canvas.mozOpaque = true;
      div.appendChild(canvas);

      canvas.width = page.width;
      canvas.height = page.height;

      var context = canvas.getContext('2d');
      context.save();
      context.fillStyle = 'rgb(255, 255, 255)';
      context.fillRect(0, 0, canvas.width, canvas.height);
      context.restore();       
      
      var textLayer = document.createElement('div');
      textLayer.className = 'textLayer';
      document.body.appendChild(textLayer);
      
      page.startRendering(context, function(){
        if (++complete == total){
                      
          window.setTimeout(function(){
            var layers = [];
            var nodes = document.querySelectorAll(".textLayer > div");
            for (var j = 0; j < nodes.length; j++){
              layers.push(nodes[j].textContent + "\n");
            }
            pdf2text = layers.join("\n");
                          
          }, 1000);
        }
      }, textLayer);
    }
    
  }
  
  function displayPreview(files) {
    var reader = new FileReader();
    reader.onload = onFileLoad;
    reader.readAsDataURL(files[0]);
  }
  
  </script> 
  
</body>
</html>
